apiVersion: v1
kind: Service
metadata:
  name: student-api-service
  labels:
    app: student-api
spec:
    ports:
    - port: 80
      protocol: TCP
      targetPort: 5000
    selector:
      app: student-api
    type: NodePort
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-deployment
  labels:
    app: student-api
spec:
  selector:
    matchLabels:
      app: student-api
  template:
    metadata:
      labels:
        app: student-api
    spec:
      containers:
        - name: flask-app
          image: registry.e2enetworks.net/poc-e2e-registry/poc-e2e-registry:fc7c93c
          ports:
            - containerPort: 5000
          env:
            - name: DB_URL
              valueFrom:
                secretKeyRef:
                  key: db_url
                  name: postgres-secret
            - name: FLASK_RUN_HOST
              valueFrom:
                configMapKeyRef:
                  key: flask_run_host
                  name: app-configmap
      initContainers:
        - name: init-db-migration
          image: registry.e2enetworks.net/poc-e2e-registry/poc-e2e-registry:fc7c93c
          env:
          - name: DB_URL
            valueFrom:
              secretKeyRef:
                key: db_url
                name: postgres-secret
          - name: MIGRATION
            valueFrom:
                configMapKeyRef:
                  key: migration
                  name: app-configmap
      imagePullSecrets:
        - name: myregistrykey
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-configmap
  labels:
    app: postgres
data:
  postgres_db: postgres
  migration: "TRUE"
  flask_run_host: 0.0.0.0

---
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
type: Opaque
data:
    postgres_user: cG9zdGdyZXM=
    postgres_password: cG9zdGdyZXM=
    db_url: cG9zdGdyZXNxbDovL3Bvc3RncmVzOkllVGhvaGNoaTl4b2hzLWlAMTAuNy4xNjIuMTE6NTQzMi9wb3N0Z3Jlcwo=
---
apiVersion: v1
kind: Secret
metadata:
  name: myregistrykey
data:
  .dockerconfigjson: ewoJImF1dGhzIjogewoJCSJyZWdpc3RyeS5lMmVuZXR3b3Jrcy5uZXQiOiB7CgkJCSJhdXRoIjogIllXSmtkV3hyWVhKcGJVQnlaV3hoYldKa1lTNWpiMjA2WW1sdWJtaFVUMVpYUlRFd056QXciCgkJfQoJfQp9Cg==
type: kubernetes.io/dockerconfigjson